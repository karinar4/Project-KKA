<!DOCTYPE html>
<html>
<head>
    <title>Data Input dan Respons JavaScript</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    
    <script src="static/data/lantai_G.geojson"></script>
    <script src="static/data/lantai_1.geojson"></script>
    <script src="static/data/bg.geojson"></script>

    <style>
        .result-box ul {
            border-top: 1px solid #000;
            padding: 15px 10px;
        }
        .result-box ul li{
            list-style: none;
            border-radius: 3px;
            padding: 15px 10px;
            cursor: pointer;
        }
        .result-box ul li:hover {
            background-color: rgb(0, 0, 100);
        }
    </style>
</head>
<body style="overflow: hidden;">
    <div style="align-items: center; background-color: black; height: 75px;" class="row text-center">
        <h1 class="text-white">Galaxy Mall 3 Maps</h1>
    </div>

    <div style="height: 100vh" class="row">
        <div class="col-3 bg-dark m-0 p-0">
            <div class="ms-2 p-3">
            <form id="data-form">
                <div class="mb-3">
                  <label for="input1" class="form-label text-white">Your Position</label>
                  <input type="text" class="form-control" id="user-data-1" autocomplete="off">
                </div>
                <div class="mb-3">
                  <label for="input2" class="form-label text-white">Goal Position</label>
                  <input type="text" class="form-control" id="user-data-2" autocomplete="off">
                </div>
                <div class="d-grid ">
                    <button type="submit" class="btn btn-primary ">Submit</button>
                </div>
              </form>
            </div>

            <div class="ms-2 result-box" style="max-height: 300px; overflow-y: scroll;">

            </div>
        </div>
        <div id="map" class="col-9">
        </div>
    </div>

    <script src="../static/js/autocomplete.js"></script>
    <script>
        let map;

        function updateMap(data){
            let rute = data.path
            let weight = data.dur
            let goal = data.goal
            console.log(rute)
            console.log(weight)
            console.log(goal[0])
            console.log(goal[1])
            console.log(goal[2])
            if (map && map.remove) {
                map.off();
                map.remove();
            }
            map = L.map('map').setView([-7.27650430356789, 112.78022015113328], 19);
            let googleStreets = L.tileLayer('http://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}',{
                maxZoom: 20,
                subdomains:['mt0','mt1','mt2','mt3']
            });
            googleStreets.addTo(map);

            let goal_markerG = L.marker(goal[0]);
            let goal_marker1 = L.marker(goal[1]);
            let goal_marker2 = L.marker(goal[2]);

            let dasar = L.geoJSON(base, {
                style: {
                    "color": "#ffffff",
                    "weight": 0,
                    "fillOpacity": 1
                }
            });
            let denahG = L.geoJSON(lantai_G, {
                onEachFeature: function (feature, layer) {
                    if ("name" in feature.properties) {
                        layer.bindPopup(feature.properties.name);
                    }
                }
            });
            let denah1 = L.geoJSON(lantai_1, {
                onEachFeature: function (feature, layer) {
                    if ("name" in feature.properties) {
                        layer.bindPopup(feature.properties.name);
                    }
                }
            });

            let polyline0 = L.polyline(rute[0], { color: 'blue' });
            let polyline1 = L.polyline(rute[1], { color: 'red' });
            let polyline2 = L.polyline(rute[2], { color: 'green' });
            console.log(polyline0);
            console.log(polyline1);
            console.log(polyline2);

            let lantaiG = L.layerGroup([googleStreets, dasar, denahG, polyline0, goal_markerG]);
            let lantai1 = L.layerGroup([googleStreets, dasar, denah1, polyline1, goal_marker1]);
            let lantai2 = L.layerGroup([googleStreets, dasar, polyline2]);

            let baseLayers = {
                "G":lantaiG,
                "1":lantai1,
                "2":lantai2,
            };

            let control = L.control.layers(baseLayers).addTo(map);
        };

        let blank = {
            "dur": 0,
            "path": [[], [], []],
            "goal": [[], [], []]
        }
        updateMap(blank);

        document.getElementById("data-form").addEventListener("submit", function(e) {
            e.preventDefault();
            let userData1 = document.getElementById("user-data-1").value;
            let userData2 = document.getElementById("user-data-2").value;
            sendDataToPython([userData1, userData2]);
        });
        
        function sendDataToPython(data) {
            fetch("/process_data", {
                method: "POST",
                body: JSON.stringify({ data: data }),
                headers: {
                    "Content-Type": "application/json"
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                updateMap(data);
            });
        }
    </script>
</body>
</html>
